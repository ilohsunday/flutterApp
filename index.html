<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Facebook Page Poster</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    button, select, textarea { margin: 10px 0; padding: 10px; font-size: 16px; }
    textarea { width: 100%; height: 100px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>üöÄ Facebook Page Poster</h2>
  <button id="loginBtn">Login with Facebook</button>

  <div id="postArea" class="hidden">
    <h3>Select a Page</h3>
    <select id="pagesDropdown"></select>

    <h3>Write a Post</h3>
    <textarea id="postMessage" placeholder="Type your message..."></textarea>
    <br>
    <button id="postBtn">Publish Post</button>
  </div>

  <script>
    const serverUrl = "https://flutterapp-9u2n.onrender.com"; // your Render server

    document.getElementById("loginBtn").addEventListener("click", () => {
      window.location.href = serverUrl + "/login";
    });

    // Helper: get query params
    function getQueryParam(param) {
      return new URLSearchParams(window.location.search).get(param);
    }

    // Step 1: After login, get token from /callback
    const code = getQueryParam("code");
    if (code) {
      fetch(`${serverUrl}/callback?code=${code}`)
        .then(res => res.json())
        .then(data => {
          const userToken = data.access_token;
          if (!userToken) {
            alert("‚ùå Login failed");
            return;
          }

          // Step 2: Get pages
          fetch(`${serverUrl}/pages?token=${userToken}`)
            .then(res => res.json())
            .then(pagesData => {
              const dropdown = document.getElementById("pagesDropdown");
              pagesData.data.forEach(page => {
                const opt = document.createElement("option");
                opt.value = JSON.stringify(page); // store page object
                opt.innerText = page.name;
                dropdown.appendChild(opt);
              });

              document.getElementById("postArea").classList.remove("hidden");

              // Step 3: Post button action
              document.getElementById("postBtn").addEventListener("click", () => {
                const selectedPage = JSON.parse(dropdown.value);
                const message = document.getElementById("postMessage").value;

                fetch(`${serverUrl}/publish`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    pageId: selectedPage.id,
                    pageAccessToken: selectedPage.access_token,
                    message
                  })
                })
                .then(res => res.json())
                .then(resp => {
                  if (resp.id) {
                    alert("‚úÖ Post published successfully!");
                  } else {
                    alert("‚ùå Failed: " + JSON.stringify(resp));
                  }
                });
              });
            });
        });
    }
  </script>
</body>
</html>